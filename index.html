<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Junior English - Speaking Practice</title>
  <style>
    body { font-family: 'Comic Sans MS', sans-serif; }

    body {
      font-family: 'Comic Sans MS', sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #f9d976, #f39f86);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      position: relative;
    }
    h1 {
      color: #fff;
      text-shadow: 2px 2px 4px #000;
      font-size: 1.5em;
      margin-top: 20px;
    }
    #welcomeScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #a5f3fc, #fbbfbc, #fde68a);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: #0f172a;
      font-size: 28px;
      text-align: center;
      overflow: hidden;
    }
    #welcomeScreen h2 {
      font-size: 2.5em;
      color: #f472b6;
      margin-bottom: 20px;
    }
    #welcomeScreen input {
      padding: 14px 28px;
      font-size: 20px;
      border: none;
      border-radius: 14px;
      margin-bottom: 20px;
      width: 280px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    #welcomeScreen button {
      margin-top: 20px;
      padding: 14px 28px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      background: linear-gradient(90deg, #38bdf8, #0ea5e9);
      color: #0f172a;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #welcomeScreen button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    #speakingArea {
      display: none;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }

    #question {
      font-size: 2em;
      background: rgba(255,255,255,0.7);
      padding: 20px;
      margin: 30px auto;
      width: 80%;
      border-radius: 20px;
      color: #1e293b;
      box-shadow: 0 5px 10px rgba(0,0,0,0.3);
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #controls button {
      margin: 10px;
      padding: 14px 28px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      background: linear-gradient(90deg, #38bdf8, #0ea5e9);
      color: #0f172a;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    #endScreen {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(0.5px);
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #endTitle {
      font-size: 3em;
      color: #f472b6;
      text-align: center;
      margin-bottom: 10px;
    }6
    #endMessage {
      font-size: 2.5em;
      color: #34d399;
      text-align: center;
      margin-bottom: 20px;
      word-wrap: break-word;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 1001;
    }

    @media (max-width: 600px) {
      #question {
        font-size: 1.4em;
        width: 90%;
      }
      #controls button {
        font-size: 18px;
        padding: 12px 24px;
      }
    }
  </style>
</head>
<body>

  <div id="welcomeScreen">
    <h2>üéâ Junior English ch√†o m·ª´ng c√°c em üéâ</h2>
    <input type="text" id="studentName" placeholder="Nh·∫≠p t√™n em...">
    <button id="startBtn">B·∫Øt ƒë·∫ßu</button>
  </div>

  <div id="speakingArea">
    <h1>üéâ Junior English, 113 L√™ Tr·ªçng T·∫•n, ƒê√† N·∫µng-0935.994359 üéâ</h1>
    <div id="question"></div>
    <div id="controls"></div>
  </div>

  <div id="endScreen">
    <div id="endTitle">üéâ Junior English üéâ</div>
    <div id="endMessage"></div>
    <canvas id="balloonCanvas"></canvas>
  </div>

<script>
// ƒêo·∫°n vƒÉn c√≥ xu·ªëng d√≤ng (s·ª≠ d·ª•ng template literal ƒë·ªÉ d·ªÖ ƒë·ªçc)
const juniorgoiy = `
T·ª´ n√†o kh√¥ng bi·∫øt em c·ª© b·ªè qua ƒë·ªÉ ti·∫øp t·ª•c n√≥i nh√©.

G·ª¢I √ù T·ª™ V·ª∞NG
I have: t√¥i c√≥
smile: c∆∞·ªùi
eat: ƒÉn
`;


const juniorword = `
T√¥i t√™n l√† ___.
T√¥i _____ tu·ªïi.
T√¥i ƒë·∫øn t·ª´ th√†nh ph·ªë ƒê√† N·∫µng.
Trong v∆∞·ªùn
T√¥i c√≥ m·ªôt con ng·ª±a
v√† m·ªôt con c·ª´u
Con ng·ª±a r·∫•t to
con c·ª´u th√¨ b·∫©n
T√¥i th√≠ch ƒÉn x√∫c x√≠ch
T√¥i c√≥ m·ªôt √°o kho√°c
T√¥i th√≠ch c∆∞·ªùi
Trong ph√≤ng ng·ªß
t√¥i c√≥ m·ªôt c√°i g∆∞∆°ng
m·ªôt c√°i t·ªß 
v√† m·ªôt c√°i ƒë·ªìng h·ªì treo t∆∞·ªùng
`;

// M·ªói d√≤ng trong juniorword l√† m·ªôt ph·∫ßn t·ª≠ c·ªßa m·∫£ng speaking
const speaking = juniorword.split("\n").map(s => s.trim()).filter(s => s);
speaking.push(""); // th√™m c√¢u tr·ªëng cu·ªëi

let audioURL = null; // t·∫°o URL d√πng l·∫°i

let countdownInterval;
let sentenceTimeout;


let sentenceTimes = []; // m·∫£ng l∆∞u {start, end} t·ª´ng c√¢u
let sentenceStart = 0;  // th·ªùi gian b·∫Øt ƒë·∫ßu c√¢u hi·ªán t·∫°i
let recordingStartTime = 0; // th·ªùi gian b·∫Øt ƒë·∫ßu to√†n b·ªô b√†i
let mediaRecorder;
let currentIndex = 0;
let chunks = [];

let audioBlob;
let studentName = "";

const welcomeScreen = document.getElementById("welcomeScreen");
const startBtn = document.getElementById("startBtn");
const studentNameInput = document.getElementById("studentName");
const speakingArea = document.getElementById("speakingArea");
const questionBox = document.getElementById("question");
const controls = document.getElementById("controls");
const endScreen = document.getElementById("endScreen");
const endMessage = document.getElementById("endMessage");

// --- B·∫Øt ƒë·∫ßu ch∆∞∆°ng tr√¨nh ---
startBtn.onclick = () => {
  studentName = studentNameInput.value.trim();
  if (!studentName) {
    alert("Vui l√≤ng nh·∫≠p t√™n tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu!");
    return;
  }
  welcomeScreen.style.display = "none";
  speakingArea.style.display = "block";
  controls.innerHTML = "";

// üü® Hi·ªÉn th·ªã g·ª£i √Ω tr∆∞·ªõc khi thu √¢m
questionBox.innerHTML = `<i style="color:#334155; font-size:0.6em; white-space:pre-line;">${juniorgoiy}</i>`;


  addButton("B·∫Øt ƒë·∫ßu thu √¢m", startRecording);
};

function getMaxTime(sentence) {
  const spaceCount = (sentence.match(/\s+/g) || []).length;
  return 7000 + spaceCount * 3000; // 7 gi√¢y c∆° b·∫£n + 3 gi√¢y m·ªói t·ª´
}

// --- Hi·ªÉn th·ªã c√¢u v√† n√∫t ---
function showSentence() {
  controls.innerHTML = "";

  // N·∫øu ch∆∞a ƒë·∫øn c√¢u cu·ªëi
  if (currentIndex < speaking.length - 1) {
    questionBox.textContent = speaking[currentIndex];
    addButton("C√¢u ti·∫øp theo", nextSentence);


// Th√™m div countdown
const countdownDiv = document.createElement("div");
countdownDiv.id = "countdown";
countdownDiv.style.color = "gray"; // ch·ªØ x√°m
countdownDiv.style.marginTop = "5px";
controls.appendChild(countdownDiv);

// T√≠nh th·ªùi gian t·ªëi ƒëa
const maxTime = getMaxTime(speaking[currentIndex]);
let remaining = Math.floor(maxTime / 1000);
countdownDiv.textContent = `Th·ªùi gian c√≤n l·∫°i: ${remaining}s`;

// C·∫≠p nh·∫≠t countdown m·ªói gi√¢y
countdownInterval = setInterval(() => {
  remaining--;
  if (remaining >= 0) countdownDiv.textContent = `Th·ªùi gian c√≤n l·∫°i: ${remaining}s`;
}, 1000);

// T·ª± chuy·ªÉn c√¢u khi h·∫øt th·ªùi gian
sentenceTimeout = setTimeout(() => {
  nextSentence(true); // auto=true: t·ª± chuy·ªÉn
}, maxTime);


  } 
  // N·∫øu l√† c√¢u cu·ªëi
  else {
    // D·ª´ng ghi √¢m tr∆∞·ªõc khi hi·ªÉn th·ªã c√°c n√∫t cu·ªëi
if (mediaRecorder && mediaRecorder.state !== "inactive") {
  mediaRecorder.stop();

const now = Date.now();
sentenceTimes.push({
  start: sentenceStart,
  end: now - recordingStartTime
});

  mediaRecorder.onstop = () => {
audioBlob = new Blob(chunks, { type: mediaRecorder.mimeType || "audio/mp4" });



    questionBox.textContent = `üéâ Ch√∫c m·ª´ng ${studentName} ƒë√£ ho√†n th√†nh b√†i Speaking! üéâ`;
    addButton("üíæ L∆∞u file speaking.mp3 v√† nghe l·∫°i", saveAndReview);
const buttons = controls.querySelectorAll("button");
const lastBtn = buttons[buttons.length - 1];
lastBtn.style.background = "linear-gradient(90deg, #f472b6, #ec4899)"; // v√†ng cam
lastBtn.style.color = "#fff";
  };
} else {
  questionBox.textContent = `üéâ Ch√∫c m·ª´ng ${studentName} ƒë√£ ho√†n th√†nh b√†i Speaking! üéâ`;
  addButton("üíæ L∆∞u file speaking.mp3 v√† nghe l·∫°i", saveAndReview);
const buttons = controls.querySelectorAll("button");
const lastBtn = buttons[buttons.length - 1];
lastBtn.style.background = "linear-gradient(90deg, #f472b6, #ec4899)"; // v√†ng cam
lastBtn.style.color = "#fff";
}
  }
}




function addButton(label, action) {
  const btn = document.createElement("button");
  btn.textContent = label;
  btn.onclick = action;
  controls.appendChild(btn);
}

async function startRecording() {
  chunks = [];
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
// T·ª± ch·ªçn ƒë·ªãnh d·∫°ng t∆∞∆°ng th√≠ch
const mimeType = MediaRecorder.isTypeSupported("audio/webm")
  ? "audio/webm"
  : "audio/mp4";
mediaRecorder = new MediaRecorder(stream, { mimeType });


    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.start();
    
    // --- Th√™m 2 d√≤ng n√†y ---
    recordingStartTime = Date.now(); // th·ªùi gian b·∫Øt ƒë·∫ßu b√†i
    sentenceStart = 0;               // th·ªùi gian b·∫Øt ƒë·∫ßu c√¢u ƒë·∫ßu

    currentIndex = 0;
    showSentence();
  } catch (err) {
    alert("Kh√¥ng th·ªÉ truy c·∫≠p micro: " + err);
  }
}


function nextSentence(auto=false) {
  // D·ª´ng countdown v√† timeout hi·ªán t·∫°i
  clearInterval(countdownInterval);
  clearTimeout(sentenceTimeout);

  // L∆∞u th·ªùi gian k·∫øt th√∫c c√¢u n·∫øu ch∆∞a l∆∞u
  if (!sentenceTimes[currentIndex]) {
    const now = Date.now();
    sentenceTimes.push({
      start: sentenceStart,
      end: now - recordingStartTime
    });
  }

  // C·∫≠p nh·∫≠t th·ªùi gian b·∫Øt ƒë·∫ßu c√¢u m·ªõi
  sentenceStart = Date.now() - recordingStartTime;

  currentIndex++;

  showSentence();
}






function playRecording() {
  const audioURL = URL.createObjectURL(audioBlob);
  questionBox.innerHTML = `
    <p>üîä ƒêang ph√°t l·∫°i:</p>
    <audio id="replayAudio" controls autoplay style="width: 100%; margin-top: 10px;">
<source src="${audioURL}" type="${audioBlob.type || 'audio/mp4'}">
      Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh.
    </audio>
  `;
  const audio = document.getElementById("replayAudio");
  audio.play(); // t·ª± ƒë·ªông ph√°t ngay sau khi b·∫•m "Nghe l·∫°i"
}


// --- L∆∞u file ---
function isChromeAndroid() {
  const ua = navigator.userAgent.toLowerCase();
  return ua.includes("android") && ua.includes("chrome") && !ua.includes("safari");
}

// === H√†m ki·ªÉm tra Safari ===
function isSafariBrowser() {
  const ua = navigator.userAgent.toLowerCase();
  return ua.includes("safari") && !ua.includes("chrome");
}


function saveRecording() {
  if (audioBlob) {
    const a = document.createElement("a");
    const url = URL.createObjectURL(audioBlob);
    a.href = url;

    // LU√îN d√πng .mp3 n·∫øu KH√îNG ph·∫£i Safari; n·∫øu l√† Safari th√¨ fallback sang .mp4
    let ext = "mp3";
    if (isSafariBrowser()) {
      ext = "mp4";
    }

    a.download = `speaking.${ext}`;

    if (typeof a.download === "undefined") {
      window.open(url); // iPhone/iPad kh√¥ng h·ªó tr·ª£ download
    } else {
      a.click();
    }
  }
}


// === L∆∞u file + Hi·ªÉn th·ªã ph·∫ßn nghe l·∫°i t·ª´ng c√¢u ===
function saveAndReview() {
  // Gh√©p t·∫•t c·∫£ c√°c ƒëo·∫°n ghi √¢m l·∫°i th√†nh m·ªôt file duy nh·∫•t
const mergedBlob = audioBlob; // d√πng 1 file duy nh·∫•t

  // L∆∞u file speaking.mp3
  const a = document.createElement("a");
  const url = URL.createObjectURL(mergedBlob);
a.href = url;

// ƒê·∫∑t ƒëu√¥i file ƒë√∫ng theo lo·∫°i
let ext = "mp3";
if (isSafariBrowser()) {
  ext = "mp4";
}
a.download = `speaking.${ext}`;
// iPhone/iPad kh√¥ng cho t·∫£i th·∫≥ng ‚Äî m·ªü tab m·ªõi ƒë·ªÉ ng∆∞·ªùi h·ªçc nghe ho·∫∑c gi·ªØ ƒë·ªÉ l∆∞u
if (typeof a.download === "undefined") {
  window.open(url);
} else {
  a.click();
}


  // Hi·ªÉn th·ªã khu v·ª±c nghe l·∫°i t·ª´ng c√¢u
  showReviewList();
}


// === Giao di·ªán nghe l·∫°i t·ª´ng c√¢u ===
function showReviewList() {
  speakingArea.style.display = "none";

  // T·∫°o v√πng hi·ªÉn th·ªã
  endScreen.style.display = "flex";
endScreen.style.background = "linear-gradient(135deg, #f9d976, #f39f86)"; // gi·ªØ n·ªÅn gi·ªëng body
endScreen.innerHTML = `
  <div style="background:rgba(255,255,255,0.85);
              padding:20px;
              border-radius:20px;
              box-shadow:0 0 15px rgba(0,0,0,0.2);
              width:90%;max-width:800px;
              max-height:85vh; overflow-y:auto;
              margin:0 auto; text-align:center;">

    
    <h1 style="color:#fff; text-shadow:2px 2px 4px #000;
               margin-bottom:20px; font-size:1.5em;">
      üéâ Junior English, 113 L√™ Tr·ªçng T·∫•n, ƒê√† N·∫µng - 0935.994359 üéâ
    </h1>


    <h2 style="text-align:center;color:#0ea5e9;">
      üîä üéâ Ch√∫c m·ª´ng ${studentName} ƒë√£ ho√†n th√†nh b√†i speaking
    </h2>
    <div id="reviewList" style="margin-top:20px;"></div>
  </div>
`;

// --- Hi·ªÉn th·ªã t·ªïng th·ªùi gian l√†m b√†i ---
if (sentenceTimes.length > 0) {
  const totalMs = sentenceTimes[sentenceTimes.length - 1].end; // th·ªùi ƒëi·ªÉm k·∫øt th√∫c c√¢u cu·ªëi
  const totalSec = Math.round(totalMs / 1000);
  const min = Math.floor(totalSec / 60);
  const sec = totalSec % 60;

  const timeDiv = document.createElement("div");
  timeDiv.innerHTML = `‚è±Ô∏è Em ƒë√£ ho√†n th√†nh b√†i trong th·ªùi gian: 
    <b style="color:#ef4444;">${min} ph√∫t ${sec} gi√¢y</b>`;
  timeDiv.style.fontSize = "1.3em";
  timeDiv.style.marginBottom = "15px";
  timeDiv.style.color = "#1e293b";
  timeDiv.style.textAlign = "center";

  // Th√™m v√†o ngay ph√≠a tr√™n ti√™u ƒë·ªÅ "üîä Nghe l·∫°i t·ª´ng c√¢u..."
  const title = endScreen.querySelector("h2");
  title.parentNode.insertBefore(timeDiv, title);
}



const listDiv = endScreen.querySelector("#reviewList");

// === N√∫t t·∫£i file speaking ===
const downloadBtn = document.createElement("button");
downloadBtn.textContent = "üíæ T·∫£i file speaking";
downloadBtn.style.marginTop = "10px";
downloadBtn.style.marginBottom = "10px";
downloadBtn.style.padding = "10px 20px";
downloadBtn.style.fontSize = "18px";
downloadBtn.style.borderRadius = "10px";
downloadBtn.style.border = "none";
downloadBtn.style.background = "linear-gradient(90deg, #fbbf24, #f59e0b)";
downloadBtn.style.color = "#fff";
downloadBtn.style.cursor = "pointer";

downloadBtn.onclick = () => {
  if (!audioBlob) {
    alert("Kh√¥ng c√≥ b·∫£n ghi √¢m ƒë·ªÉ t·∫£i!");
    return;
  }
  const a = document.createElement("a");
  const url = URL.createObjectURL(audioBlob);
  a.href = url;

  let ext = "mp3";
  if (isSafariBrowser()) ext = "mp4";
  a.download = `speaking.${ext}`;

  if (typeof a.download === "undefined") {
    window.open(url);
  } else {
    a.click();
  }
};

// Th√™m n√∫t t·∫£i ngay d∆∞·ªõi ti√™u ƒë·ªÅ
const title = endScreen.querySelector("h2");
title.parentNode.insertBefore(downloadBtn, title.nextSibling);


// === N√∫t nghe l·∫°i to√†n b·ªô b√†i n√≥i (ƒë·∫∑t ngay d∆∞·ªõi ti√™u ƒë·ªÅ) ===
const playAllBtn = document.createElement("button");
playAllBtn.textContent = "‚ñ∂Ô∏è Nghe l·∫°i to√†n b·ªô b√†i speaking";
playAllBtn.style.marginTop = "10px";
playAllBtn.style.padding = "10px 20px";
playAllBtn.style.fontSize = "18px";
playAllBtn.style.borderRadius = "10px";
playAllBtn.style.border = "none";
playAllBtn.style.background = "linear-gradient(90deg, #34d399, #10b981)";
playAllBtn.style.color = "#fff";
playAllBtn.style.cursor = "pointer";

playAllBtn.onclick = () => {
  // N·∫øu ƒëang c√≥ √¢m thanh n√†o ƒëang ph√°t (k·ªÉ c·∫£ ƒëo·∫°n c≈©), d·ª´ng l·∫°i
  if (currentAudio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
  }

  // T·∫°o m·ªõi audio ph√°t to√†n b·ªô b√†i
  if (!audioURL) audioURL = URL.createObjectURL(audioBlob);
  currentAudio = new Audio(audioURL);

  // Khi ph√°t to√†n b√†i xong th√¨ ƒë·∫∑t currentAudio = null ƒë·ªÉ tr√°nh l·ªói ch·ªìng
  currentAudio.onended = () => {
    currentAudio = null;
  };

  currentAudio.play();
};


// Th√™m n√∫t n√†y ngay b√™n d∆∞·ªõi ti√™u ƒë·ªÅ (tr∆∞·ªõc danh s√°ch)
const title2 = endScreen.querySelector("h2");
title2.parentNode.insertBefore(playAllBtn, listDiv);





  // T·∫°o danh s√°ch c√¢u + n√∫t nghe l·∫°i
  speaking.forEach((line, index) => {
    if (line.trim() === "") return; // b·ªè d√≤ng tr·ªëng
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.justifyContent = "space-between";
    row.style.alignItems = "center";
    row.style.padding = "10px";
    row.style.borderBottom = "1px solid #ddd";

    const text = document.createElement("div");
    text.textContent = line;
    text.style.flex = "1";
    text.style.textAlign = "left";

    const btn = document.createElement("button");
    btn.textContent = "üîä Nghe l·∫°i c√¢u " + (index + 1);
    btn.style.marginLeft = "10px";
    btn.style.padding = "6px 12px";
    btn.style.fontSize = "16px";
    btn.style.border = "none";
    btn.style.borderRadius = "8px";
    btn.style.background = "linear-gradient(90deg,#a5f3fc,#38bdf8)";
    btn.style.cursor = "pointer";
    btn.onclick = () => playSentence(index);

    row.appendChild(text);
    row.appendChild(btn);
    listDiv.appendChild(row);
  });


 	
}

// === Gi·∫£ l·∫≠p ph√°t l·∫°i t·ª´ng c√¢u (d√πng to√†n b·ªô file, kh√¥ng c·∫Øt ƒëo·∫°n th·ª±c) ===
// ·ªû phi√™n b·∫£n n√¢ng cao, c√≥ th·ªÉ d√πng SpeechRecognition ho·∫∑c WaveSurfer ƒë·ªÉ chia ƒëo·∫°n.
let currentAudio = null; // th√™m bi·∫øn to√†n c·ª•c, ƒë·∫∑t ·ªü ƒë·∫ßu script c≈©ng ƒë∆∞·ª£c


function playSentence(index) {
  if (!audioBlob) {
    alert("B·∫£n ghi √¢m ch∆∞a ƒë∆∞·ª£c t·∫°o. Vui l√≤ng ho√†n th√†nh b√†i n√≥i tr∆∞·ªõc!");
    return;
  }

  if (!sentenceTimes[index]) {
    alert("C√¢u n√†y ch∆∞a ƒë∆∞·ª£c ghi √¢m ho·∫∑c kh√¥ng t·ªìn t·∫°i!");
    return;
  }

  if (currentAudio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
currentAudio = null;

  }


  if (!audioURL) {
    audioURL = URL.createObjectURL(audioBlob);
  }

  currentAudio = new Audio(audioURL);
  const start = sentenceTimes[index].start / 1000;
  const end = sentenceTimes[index].end / 1000;

  currentAudio.addEventListener("loadedmetadata", () => {
    currentAudio.currentTime = start;
    currentAudio.play();

    const duration = (end - start) * 1000;
    setTimeout(() => currentAudio.pause(), duration);
  });
}


function finishAndSave() {
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    mediaRecorder.stop();
    mediaRecorder.onstop = () => {
audioBlob = new Blob(chunks, { type: mediaRecorder.mimeType || "audio/mp4" });
      saveRecording();
      showEndScreen();
    };
  } else {
    saveRecording();
    showEndScreen();
  }
}

// --- M√†n h√¨nh ch√∫c m·ª´ng ---
function showEndScreen() {
  endScreen.style.display = "none";
  speakingArea.style.display = "block";
  questionBox.textContent = `üéâ Ch√∫c m·ª´ng ${studentName} üéâ Nh·ªõ n·ªôp b√†i ƒë√£ l√†m qua Zalo nh√©üéâ
`;
  controls.innerHTML = "";
  launchBalloons();
}

// --- Hi·ªáu ·ª©ng b√≥ng bay ---
const canvas = document.getElementById("balloonCanvas");
const ctx = canvas.getContext("2d");
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();
let balloons = [];
function createBalloon() {
  balloons.push({
    x: Math.random() * canvas.width,
    y: canvas.height + 50,
    radius: 20 + Math.random() * 15,
    color: `hsl(${Math.random() * 360}, 80%, 60%)`,
    speed: 1 + Math.random() * 2
  });
}
function animateBalloons() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  balloons.forEach((b, i) => {
    b.y -= b.speed;
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.radius, 0, 2 * Math.PI);
    ctx.fillStyle = b.color;
    ctx.fill();
    ctx.strokeStyle = "#fff";
    ctx.stroke();
    if (b.y + b.radius < 0) balloons.splice(i, 1);
  });
  requestAnimationFrame(animateBalloons);
}
function launchBalloons() {
  const interval = setInterval(() => { createBalloon(); }, 200);
  setTimeout(() => clearInterval(interval), 3000);
  animateBalloons();
}
</script>

</body>
</html>